name: CD

on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed

concurrency:
  group: render-production-deploy
  cancel-in-progress: true

jobs:
  deploy-to-render:
    name: Render 배포
    if: >-
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.head_branch == 'main'
      }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read

    steps:
      - name: 배포 훅 URL 설정 확인
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK_URL" ]; then
            echo "RENDER_DEPLOY_HOOK_URL 시크릿이 비어 있습니다."
            exit 1
          fi

      - name: Render 배포 훅 호출
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: curl --fail --show-error --silent -X POST "$RENDER_DEPLOY_HOOK_URL"
